<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photographer On The Way</title>

    <style>
        #map {
            height: 100%;
        }

        html, body {
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.9.1/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
         https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.9.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.9.1/firebase-firestore.js"></script>

    <script>
      // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyAaOgkMZOfWoF5Y7i7GeWSg71WociPtNUo",
        authDomain: "bokeh-b8947.firebaseapp.com",
        databaseURL: "https://bokeh-b8947.firebaseio.com",
        projectId: "bokeh-b8947",
        storageBucket: "bokeh-b8947.appspot.com",
        messagingSenderId: "702458379707",
        appId: "1:702458379707:web:2e3e24248efc0011bad89e",
        measurementId: "G-WN09FQ314P"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();

      var db = firebase.firestore();

      function initMap() {
          if ("geolocation" in navigator) {
              function success(pos) {
                  var directionsService = new google.maps.DirectionsService();
                  var directionsRenderer = new google.maps.DirectionsRenderer({suppressMarkers: true});
                  var markers = [];

                  var center = {
                      lat: pos.coords.latitude,
                      lng: pos.coords.longitude
                  }
                  var options = {
                      zoom: 15,
                      center: center,
                      disableDefaultUI: true
                  }

                  var map = new google.maps.Map(document.getElementById('map'), options);
                  directionsRenderer.setMap(map);

                  function calcRoute(start, end) {
                      var request = {
                          origin: start,
                          destination: end,
                          travelMode: 'WALKING'
                      };

                      directionsService.route(request, (response, status) => {
                          if (status == 'OK') {
                              directionsRenderer.setDirections(response);
                          }
                      });
                  }

                  function addMarker(pos, url) {
                      var marker = new google.maps.Marker({
                          position: pos,
                          icon: url,
                          map: map
                      });
                  }

                  db.collection('photographers').doc('tiger')
                    .onSnapshot(doc => {
                        console.log("Update has been detected");
                        pLocation = {
                            lat: doc.data().lat,
                            lng: doc.data().long
                        }

                        calcRoute(pLocation, center);

                        var userIcon = {
                            url: "https://paulhan97.github.io/bokeh/images/user-location.png",
                            scaledSize: new google.maps.Size(20, 20),
                            origin: new google.maps.Point(0, 0),
                            anchor: new google.maps.Point(0, 0)
                        };
                        var ptgrIcon = {
                            url: "https://paulhan97.github.io/bokeh/images/photo-camera.png",
                            scaledSize: new google.maps.Size(40, 40),
                            origin: new google.maps.Point(0, 0),
                            anchor: new google.maps.Point(0, 0)
                        };
                        addMarker(center, userIcon);
                        addMarker(pLocation, ptgrIcon);
                    });
              }

              function error(err) {
                  console.warn('ERROR(' + err.code + '): ' + err.message);
              }

              navigator.geolocation.getCurrentPosition(success, error);
          } else {
              console.log("Browser does not support geolocation");
          }
      }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBcKboMTJqDScCPtvpLh5CwvCTi4xkitp8&callback=initMap"></script>
</body>
</html>